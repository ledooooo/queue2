<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>صفحة المدير - مركز غرب المطار</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; background: #d0e6f2; }
    .card { background: #ffffff; border-radius: 1rem; box-shadow: 0 8px 20px rgba(0,0,0,.08); }
    .highlight { background: #fef3c7 !important; animation: blink 0.6s ease-in-out 4; }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.4;}}
  </style>
</head>
<body class="min-h-screen p-6">

  <!-- ================== قسم الدخول (يختفي بعد التحقق) ================== -->
  <div id="loginSection" class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl">
    <h1 class="text-3xl font-bold text-center text-[#004156] mb-6">صفحة المدير</h1>
    <input id="adminPassword" type="password" placeholder="كلمة مرور الصفحة" class="w-full p-3 border rounded-lg text-lg mb-4">
    <button id="loginBtn" class="w-full py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800">دخول</button>
    <p id="loginError" class="text-sm text-red-600 text-center mt-2 hidden">كلمة المرور خاطئة</p>
  </div>

  <!-- ================== المحتوى الرئيسى (يُخفى حتى يدخل المدير) ================== -->
  <div id="mainContent" class="hidden space-y-8">

    <!-- عنوان الصفحة -->
    <h1 class="text-4xl font-extrabold text-center text-[#004156]">مركز غرب المطار - لوحة المدير</h1>

    <!-- قسم إضافة/تعديل عيادة -->
    <div class="max-w-4xl mx-auto card p-6 space-y-4">
      <h2 class="text-2xl font-bold text-[#004156]">إضافة / تعديل عيادة</h2>
      <input id="newClinicName" type="text" placeholder="اسم العيادة" class="w-full p-3 border rounded-lg text-lg">
      <input id="newClinicPassword" type="password" placeholder="كلمة مرور العيادة" class="w-full p-3 border rounded-lg text-lg">
      <div class="flex gap-3">
        <button id="addClinicBtn" class="flex-1 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800">أضف</button>
        <button id="saveClinicBtn" class="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 hidden">حفظ التعديل</button>
      </div>
      <p id="clinicMsg" class="text-sm text-gray-600 text-center"></p>
    </div>

    <!-- زر إعادة تعيين جميع العيادات -->
    <div class="max-w-4xl mx-auto text-center">
      <button id="resetAllBtn" class="py-3 px-6 bg-red-600 text-white rounded-lg hover:bg-red-700">إعادة تعيين جميع العيادات</button>
    </div>

    <!-- قائمة العيادات مع التحكم فى الأرقام -->
    <div class="max-w-4xl mx-auto card p-6 space-y-4">
      <h2 class="text-2xl font-bold text-[#004156]">العيادات الحالية</h2>
      <ul id="clinicsList" class="space-y-4"></ul>
    </div>

    <!-- عنصر تحكم السرعة -->
    <div id="adminSpeed" class="max-w-4xl mx-auto"></div>

  </div>

  <script type="module">
    import { db, ref, get, set, update, remove, onValue, push } from "./js/firebase-config.js";
    import { buildSpeedControl } from "./js/tts.js";

    /* ================== متغيرات الصفحة ================== */
    const loginSection   = document.getElementById('loginSection');
    const mainContent    = document.getElementById('mainContent');
    const adminPassword  = document.getElementById('adminPassword');
    const loginBtn       = document.getElementById('loginBtn');
    const loginError     = document.getElementById('loginError');

    const newClinicName     = document.getElementById('newClinicName');
    const newClinicPassword = document.getElementById('newClinicPassword');
    const addClinicBtn      = document.getElementById('addClinicBtn');
    const clinicsList       = document.getElementById('clinicsList');
    const resetAllBtn       = document.getElementById('resetAllBtn');

    const ADMIN_PASS = 'admin123'; // غيّرها لكلمة مرور الصفحة الخاصة بك

    /* ================== دخول المدير ================== */
    loginBtn.addEventListener('click', () => {
      if (adminPassword.value.trim() === ADMIN_PASS) {
        loginSection.classList.add('hidden');
        mainContent.classList.remove('hidden');
        buildSpeedControl();
        renderClinics();
      } else {
        loginError.classList.remove('hidden');
      }
    });

    /* ================== إضافة عيادة جديدة ================== */
    addClinicBtn.addEventListener('click', async () => {
      const name = newClinicName.value.trim();
      const pass = newClinicPassword.value.trim();
      if (!name || !pass) { alert('أكمل الحقول أولاً'); return; }

      const r = push(ref(db, 'clinics'));
      await set(r, { name: name, password: pass, currentNumber: 0 });
      newClinicName.value = '';
      newClinicPassword.value = '';
      renderClinics();
    });

    /* ================== عرض العيادات مع حقول التعديل و التحكم ================== */
    async function renderClinics() {
      const snap = await get(ref(db, 'clinics'));
      clinicsList.innerHTML = '';
      if (!snap.exists()) { clinicsList.innerHTML = '<li class="text-gray-500">لا توجد عيادات</li>'; return; }

      snap.forEach(ch => {
        const {name, password, currentNumber} = ch.val();
        const id = ch.key;

        clinicsList.insertAdjacentHTML('beforeend', `
          <li class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 bg-gray-50 p-4 rounded-xl">
            <!-- اسم العيادة + حقول التعديل -->
            <div class="flex-1 space-y-2">
              <input type="text" value="${name}" id="name-${id}" class="w-full p-2 border rounded text-lg font-bold text-[#2a3e48]">
              <input type="text" value="${password}" id="pass-${id}" class="w-full p-2 border rounded text-sm" placeholder="كلمة المرور">
              <div class="flex gap-2">
                <button onclick="updateClinic('${id}')" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">حفظ التعديل</button>
                <button onclick="deleteClinic('${id}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">حذف</button>
              </div>
            </div>

            <!-- التحكم فى الرقم -->
            <div class="flex items-center gap-3">
              <span class="text-2xl font-extrabold text-[#004156]">${currentNumber}</span>
              <button onclick="setSpecificNumber('${id}', ${currentNumber})" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">ضبط رقم</button>
              <button onclick="resetClinic('${id}')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">إعادة تعيين</button>
            </div>
          </li>`);
      });
    }

    /* ================== وظائف التحكم ================== */
    window.updateClinic = async (id) => {
      const newName = document.getElementById(`name-${id}`).value.trim();
      const newPass = document.getElementById(`pass-${id}`).value.trim();
      if (!newName || !newPass) { alert('أكمل الحقول أولاً'); return; }
      await update(ref(db, `clinics/${id}`), { name: newName, password: newPass });
      renderClinics();
    };

    window.deleteClinic = async (id) => {
      if (!confirm('متأكد من حذف العيادة؟')) return;
      await remove(ref(db, `clinics/${id}`));
      renderClinics();
    };

    window.setSpecificNumber = async (id, oldNumber) => {
      const newNumber = prompt(`ضع رقمًا جديدًا (الحالي: ${oldNumber})`, oldNumber);
      if (newNumber === null) return;
      const n = parseInt(newNumber, 10);
      if (isNaN(n) || n < 0) { alert('رقم غير صحيح'); return; }
      await update(ref(db, `clinics/${id}`), { currentNumber: n });
      renderClinics();
    };

    window.resetClinic = async (id) => {
      if (!confirm('متأكد من إعادة تعيين الرقم؟')) return;
      await update(ref(db, `clinics/${id}`), { currentNumber: 0 });
      // تنطيق "تمت إعادة التعيين" من ملف reset.mp3
      const audio = new Audio('audio/reset.mp3');
      audio.play().catch(() => {});
      renderClinics();
    };

    /* ================== إعادة تعيين جميع العيادات مرة واحدة ================== */
    resetAllBtn.addEventListener('click', async () => {
      if (!confirm('متأكد من إعادة تعيين جميع الأرقام إلى صفر؟')) return;
      const snap = await get(ref(db, 'clinics'));
      // ✅ استخدم forEach مباشرة على الـ Snap لضمان تنفيذ جميع التحديثات
      snap.forEach(async ch => {
        await update(ref(db, `clinics/${ch.key}`), { currentNumber: 0 });
      });
      // تنطيق "تمت إعادة التعيين" من ملف reset.mp3
      const audio = new Audio('audio/reset.mp3');
      audio.play().catch(() => {});
      renderClinics();
    });

    /* ================== أول تحميل ================== */
    renderClinics();
  </script>
</body>
</html>
